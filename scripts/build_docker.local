#!/bin/bash
set -euo pipefail

# realpath not availabe on Mac by default...
realpath() {
    [[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}"
}

CURRENT_DIR=$(dirname "$0")
ROOT_DIR="$(realpath $(dirname "$0")/..)"
echo $CURRENT_DIR
echo $ROOT_DIR
ICLOUDPD_VERSION="$(cat "$ROOT_DIR/setup.py" | grep version= | cut -d'"' -f 2)"
PYICLOUD_VERSION="$(cat "$ROOT_DIR/../pyicloud/setup.py" | grep "VERSION =" | cut -d'"' -f 2)"
cp $ROOT_DIR/../pyicloud/dist/*.whl dist/
echo "Current icloudpd version: ${ICLOUDPD_VERSION}"
echo "Current pyicloud version: ${PYICLOUD_VERSION}"

docker build \
  --progress plain \
  --no-cache \
  -t "gordonaspin/icloudpd:${ICLOUDPD_VERSION}-local" \
  -f "Dockerfile.local" \
  --build-arg ICLOUDPD_VERSION=${ICLOUDPD_VERSION} \
  --build-arg PYICLOUD_VERSION=${PYICLOUD_VERSION} \
  "$ROOT_DIR"

docker tag "gordonaspin/icloudpd:${ICLOUDPD_VERSION}-local" "gordonaspin/icloudpd:${ICLOUDPD_VERSION}-local-alpine"
docker tag "gordonaspin/icloudpd:${ICLOUDPD_VERSION}-local" "gordonaspin/icloudpd:local-latest"
